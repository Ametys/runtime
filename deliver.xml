<?xml version="1.0" encoding="UTF-8"?>
<project name="Deliver Ametys Runtime" default="deliver">
	<target name="init">		
		<!-- GENERAL PROPERTIES -->
		<property name="version" value="HEAD"/>
		<property name="svn.branch" value="trunk"/>
        
		<property name="target" location="/srv/production/livraison/Ametys/Runtime/${version}"/>
		
		<property name="baseVersion" value="1.1.0"/>
		<property name="baseVersionDir" location="${target}/../${baseVersion}"/>
		
		<property name="deliver-dir" location="deliver"/>
		<property name="templates-dir" location="templates"/>
		<property name="appli-template-dir" location="${templates-dir}/application"/>
        <property name="plugin-template-dir" location="${templates-dir}/plugin"/>
        <property name="workspace-template-dir" location="${templates-dir}/workspace"/>

		<property name="smtpServer" value="mail"/>
		<property name="destinataires" value="dev@lists.anyware-services.com"/>
		<property name="webServer" value="http://livraisons/links/Ametys/Runtime"/>
		
		<delete dir="${target}"/>
		<mkdir dir="${target}"/>
	</target>
	
	<target name="build-runtime">
		<ant antfile="build.xml" target="all" inheritall="false">
			<property name="dest-dir" location="${target}/bin"/>
			<property name="dest-doc" location="${target}/docs"/>
			<property name="tmp-dir" location="tmp"/>
			<property name="svn.branch" value="${svn.branch}"/>
			<property name="version" value="${version}"/>
		</ant>
		
		<!-- Release notes -->
		<xslt in="releaseNotes.xml" style="${deliver-dir}/releaseNotes2html.xsl" out="${target}/docs/releaseNotes.html">
			<param name="version" expression="${version}"/>
		</xslt>
		
        
        <mkdir dir="${target}/templates"/>
        
		<!-- + 
             | Template applicatif 
             + -->
		<mkdir dir="${target}/template/web"/>
		<copy todir="${target}/template/web">
			<fileset dir="${appli-template-dir}"/>
		</copy>
		
		<!-- JAR -->
		<mkdir dir="${target}/template/web/WEB-INF/lib"/>
		<copy todir="${target}/template/web/WEB-INF/lib">
			<fileset dir="main/kernel/lib">
				<exclude name="buildtime/**"/>
			</fileset>
			<fileset dir="main/plugin-core/lib"/>
			<fileset dir="${target}/bin/jar">
				<include name="ametys-runtime-${version}*.jar"/>
			</fileset>
			<fileset dir="${target}/bin/resources">
				<include name="ametys-runtime-${version}-resources.jar"/>
			</fileset>
		</copy>
		
		<!--scripts -->
		<mkdir dir="${target}/template/web/WEB-INF/scripts"/>
		<copy todir="${target}/template/web/WEB-INF/scripts">
			<fileset dir="main/plugin-core/scripts"/>
		</copy>
		
		<zip destfile="${target}/templates/webapp_template.zip" basedir="${target}/template"/>
		
		<delete dir="${target}/template"/>
        
        <!-- + 
             | Template plugin 
             + -->
        <zip destfile="${target}/templates/plugin_template.zip" basedir="${plugin-template-dir}"/>

        <!-- + 
             | Template workspace 
             + -->
        <zip destfile="${target}/templates/workspace_template.zip" basedir="${workspace-template-dir}"/>

	</target>
	
	<target name="intranet">
		<tstamp>
			<format property="today" pattern="dd/MM/yyyy HH:mm:ss z" locale="fr"/>
	  	</tstamp>
		
	   	<copy file="${deliver-dir}/template.html" tofile="${target}/index.html"/>

	   	<copy todir="${target}">
	   		<fileset dir="${deliver-dir}">
	   			<exclude name="template.html"/>
	   			<exclude name="releaseNotes2html.xsl"/>
	   			<exclude name="lib/**"/>
	   			<exclude name="src/**"/>
	   		</fileset>
		</copy>
		
		<copy todir="${target}/src">
			<fileset dir=".">
				<exclude name="tools/"/>
				<exclude name="docs/manual/"/>
				<exclude name="bootDeliver.xml"/>
				<exclude name="deliver.xml"/>
				<exclude name="deliver/img/"/>
				<exclude name="deliver/releaseNotes2html.xsl"/>
				<exclude name="deliver/template.html"/>
			</fileset>
		</copy>
		
		<!-- API Diff -->
		<mkdir dir="${target}/docs/apidiff/src"/>
		
		<copy todir="${target}/docs/apidiff/src">
			<fileset dir="main/kernel/src" includes="**/*.java"/>
			<fileset dir="main/plugin-core/src" includes="**/*.java"/>
			<fileset dir="main/workspace-admin/src" includes="**/*.java"/>
		</copy>
		
		<javadoc sourcepath="${target}/docs/apidiff/src" packagenames="org.ametys.runtime.*">
			<doclet name="jdiff.JDiff" path="tools/jdiff/jdiff.jar">
		    	<param name="-apiname" value="Ametys Runtime ${version}"/>
		    	<param name="-apidir" value="${target}/docs/apidiff/src"/>
		  	</doclet>
		</javadoc>	
		
		<javadoc destdir="${target}/docs/apidiff" sourcefiles="tools/jdiff/Null.java">
		  	<doclet name="jdiff.JDiff" path="tools/jdiff/jdiff.jar:tools/jdiff/lib/xercesImpl-2.7.1.jar:tools/jdiff/lib/xml-apis-1.3.02.jar">
		    	<param name="-stats"/>
		    	<param name="-oldapi" value="Ametys Runtime ${baseVersion}"/>
		    	<param name="-oldapidir" value="${baseVersionDir}/docs/apidiff/src"/>
		    	<param name="-newapi" value="Ametys Runtime ${version}"/>
		    	<param name="-newapidir" value="${target}/docs/apidiff/src"/>
		    	<param name="-javadocold" value="${baseVersionDir}/docs/api/"/>
		    	<param name="-javadocnew" value="${target}/docs/api/"/>
		  	</doclet>
		</javadoc>	
		
		<copy file="tools/jdiff/background.gif" todir="${target}/docs/apidiff"/>
		<copy file="tools/jdiff/black.gif" todir="${target}/docs/apidiff"/>
		
	  	<!-- Remplacement des constantes dans le fichier html -->
	  	<replace file="${target}/index.html" token="DATE" value="${today}"/>
	  	<replace file="${target}/index.html" token="VERSION" value="${version}"/>
	  	<replace file="${target}/index.html" token="SVNBRANCH" value="${svn.branch}"/>		
	</target>
	
	<target name="mail">
		<mail from="cms-dev@lists.anyware-tech.com" tolist="${destinataires}" mailhost="${smtpServer}" encoding="plain" subject="Livraison Ametys Runtime : ${version}" message="La nouvelle version ${version} d'Ametys Runtime est disponible.&#10;&#10;Version accessible a l'adresse : ${webServer}/${version}/"/>
	</target>
	
    <target name="deliver" depends="init, build-runtime, intranet, mail"/>
</project>
