<!--
   Copyright 2012 Anyware Services

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
   -->
<html>
<body>
Package providing integration of
<a href="http://ibatis.apache.org">iBATIS Database Layer</a>
with Avalon concepts.

<p>First, you need to activate the feature <code>core/runtime.sqlmap</code> which is
disable in the default <code>runtime.xml<code> provided in the default template.
</p>

<p>If you want to use SqlMap, you need to create an extension for the
extension point <code>org.ametys.runtime.plugins.core.sqlmap.SqlMapExtensionPoint</code>.<br/>
This extension will refers to an avalon component which will be injected with one or more
SqlMapClient instances.</p>

<p>For example, if you want to inject an SqlMapClient instance in the
avalon component with the role <code>com.test.MyDAO</code> and using the mapping in the classpath resource
<code>com/test/test.xml</code>, you need to declare the following extension in your <code>plugin.xml</code>:
<pre>
  &lt;feature name="myfeature" depends="core/runtime.sqlmap"&gt;
    &lt;extensions&gt;
      &lt;extension point="org.ametys.runtime.plugins.core.sqlmap.SqlMapExtensionPoint"
                 id="com.test.MyDAO"
                 class="org.ametys.runtime.plugins.core.sqlmap.SelfSqlMapClientComponentProvider"&gt;
        &lt;sqlMap resource="com/test/test.xml"/&gt;
      &lt;/extension&gt;
    &lt;/extensions&gt;
    
    &lt;components&gt;
      &lt;component role="com.test.MyDAO" class="com.test.MyDAO"/&gt;
    &lt;/components&gt;
  &lt;/feature&gt;
</pre>
If you want to specify an additionnal mapping with an alternate datasource pool (<code>mydatasource.jdbc.pool</code>),
you can define it like this:
<pre>
    &lt;extensions&gt;
      &lt;extension point="org.ametys.runtime.plugins.core.sqlmap.SqlMapExtensionPoint"
                 id="com.test.MyDAO"
                 class="org.ametys.runtime.plugins.core.sqlmap.SelfSqlMapClientComponentProvider"&gt;
        &lt;!-- use core datasource for this mapping (default) --&gt;
        &lt;sqlMap resource="com/test/test.xml"/&gt;
        &lt;!-- use my datasource for this mapping --&gt;
        &lt;sqlMap datasource="mydatasource.jdbc.pool" resource="com/test/test_external.xml"/&gt;
      &lt;/extension&gt;
    &lt;/extensions&gt;
</pre>
Remember that you have to declare your alternate datasource, like this :
<pre>
&lt;extension point="org.apache.avalon.excalibur.datasource.DataSourceComponentSelector" 
                       id="mydatasource.jdbc.pool"
                       class="org.ametys.runtime.cocoon.JDBCDataSource"
                       logger="mydatasource.jdbc.pool"&gt;
          &lt;pool-controller max="10" max-strict="true" blocking="true" timeout="0" trim-interval="60000"/&gt;
          &lt;keep-alive age="5000" disabled="false"&gt;select 1&lt;/keep-alive&gt;
          &lt;auto-commit&gt;false&lt;/auto-commit&gt;
          &lt;driver runtime-config-parameter="mydatasource.jdbc.driver"/&gt;
          &lt;dburl runtime-config-parameter="mydatasource.jdbc.url"/&gt;
          &lt;user runtime-config-parameter="mydatasource.jdbc.user"/&gt;
          &lt;password runtime-config-parameter="mydatasource.jdbc.passwd"/&gt;
&lt;/extension&gt;
</pre>
<p>
The <code>com.test.MyDAO</code> must implements <code>SqlMapClientsAware</code>.
The abstract class <code>org.ametys.runtime.plugins.core.sqlmap.dao.AbstractDAO</code>
help to retrieve the SqlMapClient instance using <code>_getSqlMapClient()</code>
and provide SQLException wrapping:
<pre>
public class MyDAO extends AbstractDAO implements ThreadSafe, Component
{
    public static final String ROLE = MyDAO.class.getName();
    
    // No SQLException wrapping
    public List&lt;Test&gt; getTestsNotWrapped() throws SQLException
    {
        return (List&lt;Test&gt;) _getSqlMapClient().queryForList("Test.getTests");
    }

    // SQLException wrapping
    public List&lt;Test&gt; getTests() throws DataAccessException
    {
        return new SQLExceptionWrapper&lt;List&lt;Test&gt;&gt;()
        {
            @Override
            public List&lt;Test&gt; processWithSqlMapClient(SqlMapClient sqlMapClient) throws SQLException
            {
                return sqlMapClient.queryForList("Test.getTests");
            }
            
        }.process();
    }
}
</pre>

<p>
TODO JUnit/DBUnit tests integration.
</p>

</body>
</html>
